请求连接阶段
1、第一次握手：客户端发送连接请求（SYN=1）后进入SYN_SENT状态。其中SN=s随机生成的x。通常TCP首部还会携带一个MSS（最大报文段长度）。
2、第二次握手：服务端收到对方的请求帧，进入SYN_RCVD状态。并返回连接请求+响应（SYN=1,ACK=1），其中AN=x+1，SN=随机生成的y。通常TCP首部也会携带一个MSS。
3、第三次握手：客户端收到第二次握手后，进入ESTABLISHED状态。并返回响应（ACK=1），其中AN=y+1。有时候客户端可能会合并要发送的数据一起发送。
4、服务段收到后也进入ESTABLISHED状态。之后双方开始数据传输

断开连接阶段
双方都可以发起断开连接请求
1、第一次挥手：主动断开方发送结束请求（FIN=1,ACK=1），然后进入FIN_WAIT_1状态。该次请求中的SN(假设x)=对方上一次响应的AN，AN(假设y)=对方上一次请求的SN+净荷字节数。这表示主动断开放没有数据要发送。
2、第二次挥手：被动方收到断开请求后返回响应（ACK=1），然后进入CLOSE-WAIT状态。其中SN=y,AN=x+1。之后被动断开放依然还有可能发送数据，主动方依然会接收。
3、第三次挥手：被动断开方完成数据发送后，或CLOSE-WAIT截止时间到后，会主动发送结束请求（FIN=1,ACK=1），然后进入LAST_ACK状态。在CLOSE-WAIT之中发送的数据对方也会响应，所以该帧SN(假设z)=对方上一次响应的AN= y+这过程的净荷字节数
4、第四次挥手：主动断开方收到结束请求后，返回响应（ACK=1），然后进入TIME-WAIT状态。因为主动方不再发送数据，所以SN=x+1,AN=z+1
5、被动方收到响应后最终关闭连接。主动方等待2MSL超时后若没收到其他报文，则证明被动方已关闭，主动方关闭连接。
*MSL为报文片段最长存活时间，一般在1~4分钟之间

相关问题
1、为什么只要三次握手：因为建立连接阶段，服务端无数据发送，所以请求连接和响应可以合并发送变成SYN+ACK报文
2、主动断开方为何等待2MSL才正式关闭连接：因为网络中有可能丢失发送的请求/响应，对方若没收到第四次挥手响应，则会重发第三次挥手，而一来一往最多需等待2MSL才能确保对方不再发送，即认为对方收到了第四次挥手。等待2MSL同样意味着需经过2MSL才能建立新连接，这样确保旧连接的报文段不会出现在新连接中。
3、建立连接后，客户端故障怎么办：TCP设有保活计时器（通常为2小时，可调整），每次收到客户端数据计时器都会复位。如果超时服务端会发送探测报文段，并每隔75s再次发送，如果10个探测报文段都无响应，则认为客户端出现故障并关闭连接/
